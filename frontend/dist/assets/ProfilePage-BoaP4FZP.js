import{u as ze,d as Ge,a as Je,r,b as S,e as Ce,g as Xe,j as e,m as x,h as Ze,i as _e}from"./index-D6M_RZne.js";import{F as es}from"./FollowButton-BLk3x6RZ.js";import{P as ss}from"./PostCard-CVlj5ZpD.js";const as=({memberId:i})=>{var ve,be,we,ye,Pe;const{currentUser:l,setUser:Se,logout:ke,linkPassword:Ee}=ze(),N=Ge(),J=Je(),[X,v]=r.useState(""),[Fe,b]=r.useState(""),[Z,u]=r.useState(""),[k,h]=r.useState(""),[_,E]=r.useState(!1),[ee,qe]=r.useState(""),[ts,ls]=r.useState(!1),[se,ae]=r.useState(""),[te,le]=r.useState(""),[ne,F]=r.useState(""),[ie,w]=r.useState(""),[re,oe]=r.useState(""),[ce,de]=r.useState(""),[me,q]=r.useState(""),[he,y]=r.useState(""),[De,g]=r.useState(!1),[Te,j]=r.useState(!1),[Me,D]=r.useState(!1),[Be,T]=r.useState(!1),P="/default-avatar.jpg",[Ae,ue]=r.useState({}),{data:d,isLoading:Ie,isError:Ke,error:C}=S({queryKey:["member",i],queryFn:()=>x.getById(i),enabled:!!i,retry:!1}),{data:M,isError:Le,error:B}=S({queryKey:["member-posts",i],queryFn:()=>x.getPosts(i),enabled:!!i,retry:!1}),{data:A,isError:ns,error:is}=S({queryKey:["member-followers",i],queryFn:()=>x.getFollowers(i),enabled:!!i,retry:!1}),{data:I,isError:rs,error:os}=S({queryKey:["member-following",i],queryFn:()=>x.getFollowing(i),enabled:!!i,retry:!1}),f=Ce({mutationFn:s=>x.update(i,s),onSuccess:s=>{var o;const t=(o=s==null?void 0:s.data)==null?void 0:o.data;if(t&&N.setQueryData(["member",i],n=>{var m;return(m=n==null?void 0:n.data)!=null&&m.data?{...n,data:{...n.data,data:{...n.data.data,...t}}}:n}),N.invalidateQueries({queryKey:["member",i]}),N.invalidateQueries({queryKey:["members"]}),t&&l&&l.id===i){const n=t.profileImage||t.image||t.picture;Se({...l,profileImage:n,image:n,picture:n})}v(""),b(""),u(""),h(""),E(!1)},onError:s=>{var o,n,m;const t=((m=(n=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:n.error)==null?void 0:m.message)||(s==null?void 0:s.message)||"Could not update profile photo. Please try again.";h(t)}}),K=Ce({mutationFn:()=>x.deleteSelf(),onSuccess:()=>{ke(),J("/login")},onError:s=>{var o,n,m;const t=((m=(n=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:n.error)==null?void 0:m.message)||(s==null?void 0:s.message)||"Could not delete account. Please try again.";qe(t)}}),Qe=(ve=d==null?void 0:d.data)!=null&&ve.data?Xe([d.data.data.profileImage,d.data.data.picture,d.data.data.image],Ae,P):P;if(Ie)return e.jsx("div",{className:"profile-container",children:e.jsx("div",{className:"spinner"})});if(Ke)return e.jsx("div",{className:"profile-container",children:e.jsx("div",{className:"error-message",children:C!=null&&C.message?`Error loading member: ${C.message}`:"Error loading member"})});const a=(be=d==null?void 0:d.data)==null?void 0:be.data;if(!a)return e.jsx("div",{className:"profile-container",children:e.jsx("div",{className:"error-message",children:"Member not found"})});const L=((we=M==null?void 0:M.data)==null?void 0:we.data)||[],Re=((ye=A==null?void 0:A.data)==null?void 0:ye.data)||[],Ye=((Pe=I==null?void 0:I.data)==null?void 0:Pe.data)||[],p=l&&l.id===i,ge=a.locked===!0,fe=p&&(l==null?void 0:l.email)&&!(l!=null&&l.hasPassword)&&(l==null?void 0:l.role)!=="guest",c=p&&(l==null?void 0:l.hasPassword)&&(l==null?void 0:l.role)!=="guest",$e=s=>{s.target.onerror=null,ue(t=>({...t,[s.target.src]:!0})),s.target.src=P},pe=s=>{const t=[];return s.dev&&t.push("Dev"),s.des&&t.push("Design"),s.pm&&t.push("PM"),s.core&&t.push("Core"),s.mentor&&t.push("Mentor"),t},Oe=s=>{s.preventDefault();const t=(Fe||X).trim();if(!t){h("Please select a file or enter an image URL");return}f.mutate({profileImage:t,image:t,picture:t})},Ue=async s=>{var o;const t=(o=s.target.files)==null?void 0:o[0];if(!t){b(""),u("");return}if(!t.type.startsWith("image/")){h("Please select an image file");return}try{h(""),u("Uploading...");const n=await Ze(t,l.id);v(n),b(""),u(t.name)}catch(n){h((n==null?void 0:n.message)||"Could not upload image"),u("")}},We=()=>{const s=P;f.mutate({profileImage:s,image:s,picture:s}),ue({})},Q=a.favoriteThing1||a["favorite thing 1"]||"",R=a.favoriteThing2||a["favorite thing 2"]||"",Y=a.favoriteThing3||a["favorite thing 3"]||"",$=a.favoriteDartmouthTradition||a["favorite dartmouth tradition"]||"",O=a.funFact||a["fun fact"]||"",U=a.quote||a.quote||"",W=a.major||a.major||"",H=a.minor||a.minor||"",V=a.home||a.home||"",z=a.birthday||a.birthday||"",G=a.year||a.year||"",xe=W||H||V||z||G,je=Q||R||Y,Ne=$||O||U,He=xe||je||Ne,Ve=()=>e.jsxs("div",{className:"full-profile-body",children:[xe&&e.jsxs("div",{className:"profile-facts",children:[e.jsx("h3",{children:"Details"}),e.jsxs("div",{className:"profile-facts-grid",children:[G&&e.jsxs("div",{className:"fact",children:[e.jsx("span",{className:"fact-label",children:"Year"}),e.jsx("span",{className:"fact-value",children:G})]}),W&&e.jsxs("div",{className:"fact",children:[e.jsx("span",{className:"fact-label",children:"Major"}),e.jsx("span",{className:"fact-value",children:W})]}),H&&e.jsxs("div",{className:"fact",children:[e.jsx("span",{className:"fact-label",children:"Minor"}),e.jsx("span",{className:"fact-value",children:H})]}),V&&e.jsxs("div",{className:"fact",children:[e.jsx("span",{className:"fact-label",children:"Home"}),e.jsx("span",{className:"fact-value",children:V})]}),z&&e.jsxs("div",{className:"fact",children:[e.jsx("span",{className:"fact-label",children:"Birthday"}),e.jsx("span",{className:"fact-value",children:z})]})]})]}),je&&e.jsxs("div",{className:"profile-favorites",children:[e.jsx("h3",{children:"Favorites"}),e.jsxs("ul",{className:"favorites-list",children:[Q&&e.jsx("li",{children:Q}),R&&e.jsx("li",{children:R}),Y&&e.jsx("li",{children:Y})]})]}),Ne&&e.jsxs("div",{className:"profile-extras",children:[$&&e.jsxs("div",{className:"extra-row",children:[e.jsx("span",{className:"fact-label",children:"Dartmouth tradition"}),e.jsx("span",{className:"fact-value",children:$})]}),O&&e.jsxs("div",{className:"extra-row",children:[e.jsx("span",{className:"fact-label",children:"Fun fact"}),e.jsx("span",{className:"fact-value",children:O})]}),U&&e.jsx("blockquote",{className:"profile-quote",children:U})]})]});return e.jsxs("div",{className:"profile-container",children:[e.jsxs("div",{className:"profile-header card",children:[e.jsx("div",{className:"profile-avatar-section",children:e.jsx("img",{src:Qe,alt:a.name,className:"profile-avatar",onError:$e})}),e.jsxs("div",{className:"profile-info",children:[e.jsxs("div",{className:"profile-name-section",children:[e.jsx("h1",{className:"profile-name",children:a.name}),!p&&l&&e.jsx(es,{followerId:l.id,followingId:i}),p&&e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>J("/profile/edit"),children:"Edit profile"}),e.jsx("button",{className:"btn btn-secondary settings-toggle",onClick:()=>g(!0),"aria-label":"Open settings",children:e.jsx("img",{src:"/settings.svg",alt:"",className:"settings-icon"})})]})]}),e.jsxs("div",{className:"profile-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("strong",{children:L.length}),e.jsx("span",{children:"posts"})]}),e.jsxs("div",{className:"stat",children:[e.jsx("strong",{children:Re.length}),e.jsx("span",{children:"followers"})]}),e.jsxs("div",{className:"stat",children:[e.jsx("strong",{children:Ye.length}),e.jsx("span",{children:"following"})]})]}),a.bio&&e.jsx("div",{className:"profile-bio",children:e.jsx("p",{children:a.bio})}),a.interests&&a.interests.length>0&&e.jsx("div",{className:"profile-interests",children:a.interests.map((s,t)=>e.jsx("span",{className:"interest-tag",children:s},t))}),pe(a).length>0&&e.jsx("div",{className:"profile-badges",children:pe(a).map(s=>e.jsx("span",{className:"badge",children:s},s))}),p&&e.jsxs("div",{className:"profile-image-card card",children:[e.jsxs("div",{className:"profile-image-card-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Profile photo"}),e.jsx("p",{className:"muted",children:"Upload a new image or paste a URL."})]}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>E(s=>!s),children:_?"Close":"Change photo"})]}),_&&e.jsxs("form",{className:"profile-image-form",onSubmit:Oe,style:{marginTop:"0.5rem"},children:[e.jsxs("div",{className:"file-input-row",children:[e.jsx("input",{id:"profile-file",type:"file",accept:"image/*",onChange:Ue,className:"file-input-hidden"}),e.jsx("label",{htmlFor:"profile-file",className:"file-trigger",children:"Choose image"}),Z&&e.jsx("span",{className:"selected-file subtle",children:Z})]}),e.jsx("input",{type:"text",className:"input",placeholder:"Image URL (optional)",value:X,onChange:s=>v(s.target.value),style:{margin:"0.3rem 0"}}),k&&e.jsx("div",{className:"error-message",children:k}),f.isSuccess&&!k&&e.jsx("div",{className:"success-message",children:"Photo updated"}),e.jsxs("div",{className:"profile-image-actions",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:f.isPending,children:f.isPending?"Saving...":"Save photo"}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>{b(""),v(""),u(""),h(""),E(!1)},children:"Cancel"}),e.jsx("button",{type:"button",className:"btn btn-danger",style:{backgroundColor:"#b00020",borderColor:"#b00020",color:"#fff"},onClick:We,disabled:f.isPending,children:"Remove photo"})]})]})]}),(a.role||a.year)&&e.jsxs("div",{className:"profile-meta",children:[a.role&&e.jsx("span",{children:a.role}),a.year&&e.jsx("span",{children:a.year})]}),He&&e.jsx("button",{type:"button",className:"btn btn-secondary",style:{alignSelf:"flex-start",marginTop:"0.35rem"},onClick:()=>T(!0),children:"View full profile"})]})]}),Be&&e.jsx("div",{className:"modal-backdrop",onClick:()=>T(!1),children:e.jsxs("div",{className:"modal-card full-profile-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Full profile"}),e.jsx("button",{className:"icon-btn",onClick:()=>T(!1),children:"✕"})]}),Ve()]})}),p&&De&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-card",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Settings"}),e.jsx("button",{className:"icon-btn",onClick:()=>g(!1),children:"✕"})]}),e.jsxs("div",{className:"settings-modal-body",children:[fe&&e.jsx("button",{className:"btn btn-primary",onClick:()=>{j(!0),g(!1)},children:"Add password"}),c&&e.jsx("button",{className:"btn btn-primary",onClick:()=>{j(!0),g(!1)},children:"Change password"}),ge&&e.jsx("button",{className:"btn btn-danger danger-outline",onClick:()=>{D(!0),g(!1)},children:"Delete my account"})]})]})}),Te&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-card",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:c?"Change password":"Add password"}),e.jsx("button",{className:"icon-btn",onClick:()=>j(!1),children:"✕"})]}),e.jsx("p",{className:"muted",style:{marginBottom:"0.5rem"},children:c?"Update the password for your account.":"Set a password so you can also sign in with email."}),fe&&e.jsxs("label",{className:"muted",style:{display:"block",marginBottom:"0.5rem"},children:["Email",e.jsx("input",{className:"input",type:"email",value:l.email,disabled:!0,style:{marginTop:"0.25rem"}})]}),e.jsxs("label",{style:{display:"block",marginBottom:"0.5rem"},children:["New password",e.jsx("input",{className:"input",type:"password",value:c?re:se,onChange:s=>c?oe(s.target.value):ae(s.target.value),style:{marginTop:"0.25rem"}})]}),e.jsxs("label",{style:{display:"block",marginBottom:"0.75rem"},children:["Confirm password",e.jsx("input",{className:"input",type:"password",value:c?ce:te,onChange:s=>c?de(s.target.value):le(s.target.value),style:{marginTop:"0.25rem"}})]}),(ie||he)&&e.jsx("div",{className:"error-message",children:ie||he}),(ne||me)&&e.jsx("div",{className:"success-message",children:ne||me}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{j(!1),g(!0)},children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{c?(y(""),q("")):(w(""),F(""));const s=c?re:se,t=c?ce:te;if(!s||s.length<6){(c?y:w)("Password must be at least 6 characters");return}if(s!==t){(c?y:w)("Passwords do not match");return}try{c?(await changePassword(s),q("Password updated."),oe(""),de(""),setTimeout(()=>q(""),1500)):(await Ee(l.email,s),F("Password added. You can now sign in with email + password."),ae(""),le(""),setTimeout(()=>F(""),1500),N.invalidateQueries({queryKey:["member",i]})),j(!1)}catch(o){const n=(o==null?void 0:o.message)==="Firebase: Error (auth/requires-recent-login)."?"Please log out and sign in again, then retry.":(o==null?void 0:o.message)||"Could not update password. Try again.";(c?y:w)(n)}},children:"Save"})]})]})}),ge&&Me&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-card danger",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{style:{color:"#b00020"},children:"Delete my account"}),e.jsx("button",{className:"icon-btn",onClick:()=>D(!1),children:"✕"})]}),e.jsx("p",{className:"muted",style:{marginBottom:"1rem"},children:"This permanently removes your profile, posts, likes, and follows. You’ll need to create a new account to use the app again."}),ee&&e.jsx("div",{className:"error-message",children:ee}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>D(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-danger",style:{backgroundColor:"#b00020",borderColor:"#b00020",color:"#fff",fontWeight:600},disabled:K.isPending,onClick:()=>{window.confirm("Delete your account? This cannot be undone.")&&K.mutate()},children:K.isPending?"Deleting...":"Delete my account"})]})]})}),e.jsxs("div",{className:"profile-posts",children:[e.jsx("h2",{className:"profile-posts-title",children:"Posts"}),Le?e.jsxs("div",{className:"error-message",children:["Error loading posts: ",(B==null?void 0:B.message)||"Unknown error"]}):L.length===0?e.jsx("div",{className:"empty-posts",children:e.jsx("p",{children:"No posts yet"})}):e.jsx("div",{className:"posts-grid",children:L.map(s=>e.jsx(ss,{post:s},s.id))})]})]})},hs=()=>{const{memberId:i}=_e();return e.jsx("div",{className:"profile-page",children:e.jsx(as,{memberId:i})})};export{hs as default};
