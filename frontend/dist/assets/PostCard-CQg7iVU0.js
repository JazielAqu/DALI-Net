import{u as M,d as A,e as p,l as P,j as s,k as K,r as h,b as C,n as S,g as Q,p as E,L}from"./index-9FpdTuGE.js";const T=({postId:n,isLiked:a,likeCount:u})=>{const{currentUser:i}=M(),m=(i==null?void 0:i.role)==="guest",l=A(),j=p({mutationFn:()=>P.like({postId:n}),onSuccess:()=>{l.invalidateQueries({queryKey:["likes",n]}),l.invalidateQueries({queryKey:["posts"]}),l.invalidateQueries({queryKey:["feed"]})}}),f=p({mutationFn:()=>P.unlike(n),onSuccess:()=>{l.invalidateQueries({queryKey:["likes",n]}),l.invalidateQueries({queryKey:["posts"]}),l.invalidateQueries({queryKey:["feed"]})}}),x=async()=>{var y;if(!i||m){alert("Sign in (not as guest) to like posts");return}const N=async()=>{const c=K.currentUser;if(!c)return;const d=await c.getIdToken(!0);d&&localStorage.setItem("authToken",d)},g=async()=>{a?await f.mutateAsync():await j.mutateAsync()};try{await N(),await g()}catch(c){if(((y=c==null?void 0:c.response)==null?void 0:y.status)===401)try{await N(),await g()}catch(d){console.error("Like failed after retry",d),alert("Session issue: please sign out and sign back in, then try again.")}else console.error("Like failed",c),alert("Unable to like right now. Please try again.")}},b=j.isPending||f.isPending;return s.jsxs("button",{className:`like-btn ${a?"liked":""}`,onClick:x,disabled:b||!i||m,children:[s.jsx("span",{className:"like-icon",children:a?"â¤ï¸":"ðŸ¤"}),u>0&&s.jsx("span",{className:"like-count",children:u})]})},$=({postId:n})=>{const{currentUser:a}=M(),u=(a==null?void 0:a.role)==="guest",i=A(),[m,l]=h.useState(""),[j,f]=h.useState(new Date),[x,b]=h.useState({}),N=t=>e=>{e.target.onerror=null,b(r=>({...r,[e.target.src]:!0})),e.target.src="/default-avatar.jpg"};h.useEffect(()=>{const t=setInterval(()=>f(new Date),6e4);return()=>clearInterval(t)},[]);const{data:g=[],isLoading:y,isError:c}=C({queryKey:["comments",n],queryFn:async()=>{var e;return((e=(await S.getByPost(n)).data)==null?void 0:e.data)||[]}}),d=p({mutationFn:t=>S.create(t),onSuccess:t=>{var r;const e=(r=t.data)==null?void 0:r.data;l(""),e?i.setQueryData(["comments",n],(o=[])=>[...o,e]):i.invalidateQueries({queryKey:["comments",n]})}}),k=p({mutationFn:t=>S.delete(t,{userId:a==null?void 0:a.id}),onSuccess:(t,e)=>{i.setQueryData(["comments",n],(r=[])=>r.filter(o=>o.id!==e))}}),v=t=>{t.preventDefault(),!(!m.trim()||!a||u)&&d.mutate({userId:a.id,postId:n,content:m.trim()})},I=t=>{if(!t)return null;if(t.toDate)return t.toDate();if(typeof t=="number"||typeof t=="string")return new Date(t);if(t._seconds||t.seconds){const r=(t._seconds??t.seconds)*1e3+Math.floor((t._nanoseconds??t.nanoseconds??0)/1e6);return new Date(r)}return new Date(t)},q=t=>{const e=I(t);if(!e||Number.isNaN(e.getTime()))return"just now";const r=j-e,o=Math.floor(r/6e4),w=Math.floor(r/36e5),D=Math.floor(r/864e5);return o<1?"just now":o<60?`${o}m ago`:w<24?`${w}h ago`:D<7?`${D}d ago`:e.toLocaleDateString()};return s.jsxs("div",{className:"comment-section",children:[a&&!u&&s.jsxs("form",{className:"comment-form",onSubmit:v,children:[s.jsx("input",{type:"text",className:"comment-input",placeholder:"Write a comment...",value:m,onChange:t=>l(t.target.value),disabled:d.isPending}),s.jsx("button",{type:"submit",className:"comment-submit-btn",disabled:!m.trim()||d.isPending,children:"Post"})]}),s.jsx("div",{className:"comments-list",children:c?s.jsx("div",{className:"loading-comments",children:"Failed to load comments"}):y?s.jsx("div",{className:"loading-comments",children:"Loading comments..."}):g.length===0?s.jsx("div",{className:"no-comments",children:"No comments yet"}):g.map(t=>s.jsxs("div",{className:"comment-item",children:[s.jsx("img",{src:x[t.userImage]?"/default-avatar.jpg":Q([t.userImage],x,"/default-avatar.jpg"),alt:t.userName,className:"comment-avatar",onError:N(t.id)}),s.jsxs("div",{className:"comment-content",children:[s.jsxs("div",{className:"comment-header",children:[s.jsx("strong",{className:"comment-author",children:t.userName}),s.jsx("span",{className:"comment-time",children:q(t.createdAt)})]}),s.jsx("p",{className:"comment-text",children:t.content})]}),a&&a.id===t.userId&&s.jsx("button",{className:"comment-delete-btn",onClick:()=>k.mutate(t.id),disabled:k.isPending,children:"Ã—"})]},t.id))})]})},B=({post:n})=>{const{currentUser:a}=M(),u=A(),[i,m]=h.useState(!1),[l,j]=h.useState(new Date),f="/default-avatar.jpg",[x,b]=h.useState({}),N=a&&a.id===n.authorId?[a.profileImage,a.image,a.picture,n.authorImage,n.authorImageFallback]:[n.authorImage,n.authorImageFallback],g=Q(N,x,f);h.useEffect(()=>{const e=setInterval(()=>j(new Date),6e4);return()=>clearInterval(e)},[]);const{data:y=[]}=C({queryKey:["likes",n.id],queryFn:async()=>{var r;return((r=(await P.getByPost(n.id)).data)==null?void 0:r.data)||[]}}),{data:c=[]}=C({queryKey:["comments",n.id],queryFn:async()=>{var r;return((r=(await S.getByPost(n.id)).data)==null?void 0:r.data)||[]}}),d=a&&y.some(e=>e.userId===a.id),k=p({mutationFn:()=>E.delete(n.id,{userId:a==null?void 0:a.id}),onSuccess:()=>{u.invalidateQueries({queryKey:["feed"]}),u.invalidateQueries({queryKey:["posts"]}),u.invalidateQueries({queryKey:["member-posts",n.authorId]})}}),v=()=>{!a||a.id!==n.authorId||!window.confirm("Delete this post? This cannot be undone.")||k.mutate()},I=e=>{e.target.onerror=null,b(r=>({...r,[e.target.src]:!0})),e.target.src=f},q=e=>{if(!e)return null;if(e.toDate)return e.toDate();if(typeof e=="number"||typeof e=="string")return new Date(e);if(e._seconds||e.seconds){const o=(e._seconds??e.seconds)*1e3+Math.floor((e._nanoseconds??e.nanoseconds??0)/1e6);return new Date(o)}return new Date(e)},t=e=>{const r=q(e);if(!r||Number.isNaN(r.getTime()))return"just now";const o=l-r,w=Math.floor(o/6e4),D=Math.floor(o/36e5),F=Math.floor(o/864e5);return w<1?"just now":w<60?`${w}m ago`:D<24?`${D}h ago`:F<7?`${F}d ago`:r.toLocaleDateString()};return s.jsxs("div",{className:"post-card",children:[s.jsxs("div",{className:"post-header",children:[s.jsx("div",{className:"post-author",children:s.jsxs(L,{to:`/profile/${n.authorId}`,className:"post-author-link",children:[s.jsx("img",{src:g,alt:n.authorName,className:"post-avatar",onError:I}),s.jsxs("div",{className:"post-author-info",children:[s.jsx("strong",{className:"post-author-name",children:n.authorName}),s.jsx("span",{className:"post-time",children:t(n.createdAt)})]})]})}),a&&a.id===n.authorId&&s.jsx("div",{className:"post-owner-actions",children:s.jsx("button",{className:"post-delete-btn",onClick:v,disabled:k.isPending,children:k.isPending?"Deletingâ€¦":"Delete"})})]}),n.content&&s.jsx("div",{className:"post-content",children:s.jsx("p",{children:n.content})}),n.imageUrl&&s.jsx("div",{className:"post-image",children:s.jsx("img",{src:n.imageUrl,alt:"Post"})}),s.jsxs("div",{className:"post-actions",children:[s.jsx(T,{postId:n.id,isLiked:d,likeCount:y.length}),s.jsxs("button",{className:"post-action-btn",onClick:()=>m(!i),children:["ðŸ’¬ ",c.length>0&&s.jsx("span",{children:c.length})]})]}),i&&s.jsx($,{postId:n.id})]})};export{B as P};
